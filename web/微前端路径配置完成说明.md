 # å¾®å‰ç«¯è·¯å¾„é…ç½®å®Œæˆè¯´æ˜

## ğŸ¯ ä¿®æ”¹ç›®æ ‡

ä¸ºäº†æ”¯æŒå¾®åº”ç”¨è®¿é—®æ—¶æ‰€æœ‰çš„æ¥å£å’Œé™æ€èµ„æºéƒ½è‡ªåŠ¨åŠ ä¸Š `/ragflow/` å‰ç¼€ï¼Œæˆ‘ä»¬å¯¹é¡¹ç›®è¿›è¡Œäº†å…¨é¢çš„è·¯å¾„é…ç½®ä¼˜åŒ–ã€‚

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. åˆ›å»ºç»Ÿä¸€çš„è·¯å¾„å·¥å…· (`src/utils/path-util.ts`)

æ–°å¢äº†ä¸€ä¸ªç»Ÿä¸€çš„è·¯å¾„å·¥å…·æ–‡ä»¶ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

- `isQiankunEnv()`: æ£€æŸ¥æ˜¯å¦åœ¨qiankunå¾®å‰ç«¯ç¯å¢ƒä¸­è¿è¡Œ
- `getPublicPath()`: è·å–å½“å‰çš„å…¬å…±è·¯å¾„
- `getResourcePath(resourcePath)`: è·å–é™æ€èµ„æºçš„å®Œæ•´è·¯å¾„
- `getApiPrefix()`: è·å–APIè·¯å¾„å‰ç¼€
- `getApiUrl(apiPath)`: è·å–å®Œæ•´çš„API URL
- `getBaseUrl()`: è·å–åŸºç¡€URLï¼ˆç”¨äºfetchç­‰åŸç”Ÿè¯·æ±‚ï¼‰
- `getPdfWorkerPath()`: è·å–PDF Workerè·¯å¾„
- `setupPdfWorker()`: è®¾ç½®PDF Workerè·¯å¾„

### 2. æ›´æ–°APIè¯·æ±‚æ‹¦æˆªå™¨ (`src/utils/request.ts`)

ä¿®æ”¹äº†è¯·æ±‚æ‹¦æˆªå™¨ï¼Œä½¿ç”¨æ–°çš„è·¯å¾„å·¥å…·ï¼š

```typescript
const apiPrefix = getApiPrefix();
if (apiPrefix) {
  finalUrl = `${apiPrefix}${url}`;
  console.log('[Request Interceptor] Final URL with prefix:', finalUrl);
}
```

### 3. æ›´æ–°è®¤è¯å·¥å…· (`src/utils/authorization-util.ts`)

ç®€åŒ–äº†APIåŸºç¡€URLçš„è·å–é€»è¾‘ï¼Œä½¿ç”¨ç»Ÿä¸€çš„è·¯å¾„å·¥å…·ï¼š

```typescript
function getApiBaseUrl(): string {
  return getBaseUrl();
}
```

### 4. æ›´æ–°æ‰€æœ‰æ–‡ä»¶å¼•ç”¨

å°†æ‰€æœ‰åŸæ¥å¼•ç”¨ `@/utils/resource-path` çš„æ–‡ä»¶æ›´æ–°ä¸ºä½¿ç”¨ `@/utils/path-util`ï¼š

- `src/app.tsx`
- `src/components/dev-info.tsx`
- `src/components/pdf-previewer/index.tsx`
- `src/pages/document-viewer/pdf/index.tsx`
- `src/pages/add-knowledge/components/knowledge-chunk/components/document-preview/preview.tsx`
- `src/pages/chunk/parsed-result/add-knowledge/components/knowledge-chunk/components/document-preview/preview.tsx`
- `src/pages/chunk/parsed-result/knowledge-chunk/components/document-preview/preview.tsx`

### 5. æ¸…ç†å†—ä½™æ–‡ä»¶

åˆ é™¤äº†ä»¥ä¸‹ä¸å†éœ€è¦çš„æ–‡ä»¶ï¼š
- `src/utils/resource-path.ts`
- `src/utils/pdf-worker-util.ts`

## ğŸš€ åŠŸèƒ½è¯´æ˜

### ç‹¬ç«‹è¿è¡Œæ¨¡å¼
- æ‰€æœ‰APIè¯·æ±‚ï¼šç›´æ¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ `/v1/user/info`
- é™æ€èµ„æºï¼šä½¿ç”¨æ ¹è·¯å¾„ï¼Œå¦‚ `/logo.svg`

### å¾®å‰ç«¯æ¨¡å¼
- æ‰€æœ‰APIè¯·æ±‚ï¼šè‡ªåŠ¨æ·»åŠ  `/ragflow/` å‰ç¼€ï¼Œå¦‚ `/ragflow/v1/user/info`
- é™æ€èµ„æºï¼šè‡ªåŠ¨æ·»åŠ  `/ragflow/` å‰ç¼€ï¼Œå¦‚ `/ragflow/logo.svg`

### è‡ªåŠ¨æ£€æµ‹æœºåˆ¶
ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹æ˜¯å¦åœ¨qiankunå¾®å‰ç«¯ç¯å¢ƒä¸­è¿è¡Œï¼š

1. æ£€æŸ¥ `window.__POWERED_BY_QIANKUN__` æ˜¯å¦å­˜åœ¨
2. å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨ `window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__` ä½œä¸ºè·¯å¾„å‰ç¼€
3. å¦‚æœæ²¡æœ‰æ³¨å…¥è·¯å¾„ï¼Œä½¿ç”¨é»˜è®¤çš„ `/ragflow/` å‰ç¼€
4. ç‹¬ç«‹è¿è¡Œæ—¶ï¼Œä¸æ·»åŠ ä»»ä½•å‰ç¼€

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨é™æ€èµ„æº

```typescript
import { getResourcePath } from '@/utils/path-util';

// è·å–logoè·¯å¾„
const logoPath = getResourcePath('logo.svg');
// ç‹¬ç«‹è¿è¡Œæ—¶: '/logo.svg'
// å¾®å‰ç«¯æ—¶: '/ragflow/logo.svg'

// åœ¨JSXä¸­ä½¿ç”¨
<img src={logoPath} alt="Logo" />
```

### åœ¨æœåŠ¡ä¸­ä½¿ç”¨API

```typescript
import { getApiUrl, getBaseUrl } from '@/utils/path-util';

// æ–¹å¼1: ä½¿ç”¨getApiUrlï¼ˆæ¨èç”¨äºç›¸å¯¹è·¯å¾„ï¼‰
const apiUrl = getApiUrl('/v1/user/info');
// ç‹¬ç«‹è¿è¡Œæ—¶: '/v1/user/info'
// å¾®å‰ç«¯æ—¶: '/ragflow/v1/user/info'

// æ–¹å¼2: ä½¿ç”¨getBaseUrlï¼ˆæ¨èç”¨äºfetchç­‰åŸç”Ÿè¯·æ±‚ï¼‰
const fullUrl = `${getBaseUrl()}/v1/user/info`;
// ç‹¬ç«‹è¿è¡Œæ—¶: 'http://localhost:8000/v1/user/info'
// å¾®å‰ç«¯æ—¶: 'http://localhost:8000/ragflow/v1/user/info'
```

### PDF Workeré…ç½®

```typescript
import { getPdfWorkerPath, setupPdfWorker } from '@/utils/path-util';

// è·å–PDF Workerè·¯å¾„
const workerPath = getPdfWorkerPath();
// ç‹¬ç«‹è¿è¡Œæ—¶: '/pdfjs-dist/pdf.worker.min.js'
// å¾®å‰ç«¯æ—¶: '/ragflow/pdfjs-dist/pdf.worker.min.js'

// è®¾ç½®PDF Workerï¼ˆé€šå¸¸åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼‰
await setupPdfWorker();
```

## ğŸ”§ é…ç½®è¯´æ˜

### UMIé…ç½® (`.umirc.ts`)

è·¯å¾„é…ç½®æ ¹æ® `MICRO_APP` ç¯å¢ƒå˜é‡åŠ¨æ€è®¾ç½®ï¼š

```typescript
// æ ¹æ®å¾®åº”ç”¨è¿è¡Œç¯å¢ƒåŠ¨æ€è®¾ç½®è·¯å¾„é…ç½®
base: process.env.MICRO_APP === 'true' ? '/ragflow/' : '/',
// ä¿®å¤publicPathé…ç½® - å¾®å‰ç«¯ç¯å¢ƒä¸‹ä½¿ç”¨/ragflow/å‰ç¼€
publicPath: process.env.MICRO_APP === 'true' ? '/ragflow/' : '/',
```

### æ„å»ºè„šæœ¬

```json
{
  "scripts": {
    "build": "umi build",                    // ç‹¬ç«‹åº”ç”¨æ„å»º
    "build:micro": "cross-env MICRO_APP=true umi build",  // å¾®åº”ç”¨æ„å»º
    "dev": "umi dev",                        // ç‹¬ç«‹å¼€å‘
    "dev:micro": "cross-env MICRO_APP=true umi dev --port 2080" // å¾®åº”ç”¨å¼€å‘
  }
}
```

## ğŸ‰ éªŒè¯ç»“æœ

âœ… æ„å»ºæˆåŠŸé€šè¿‡  
âœ… æ‰€æœ‰æ–‡ä»¶å¼•ç”¨æ›´æ–°å®Œæˆ  
âœ… è·¯å¾„é…ç½®è‡ªåŠ¨é€‚é…å¾®å‰ç«¯ç¯å¢ƒ  
âœ… APIè¯·æ±‚è‡ªåŠ¨æ·»åŠ å‰ç¼€  
âœ… é™æ€èµ„æºè‡ªåŠ¨æ·»åŠ å‰ç¼€  

## ğŸ“‹ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®æ”¹ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

1. **ç»Ÿä¸€çš„è·¯å¾„ç®¡ç†**ï¼šæ‰€æœ‰è·¯å¾„ç›¸å…³çš„é€»è¾‘éƒ½é›†ä¸­åœ¨ `path-util.ts` ä¸­
2. **è‡ªåŠ¨ç¯å¢ƒæ£€æµ‹**ï¼šç³»ç»Ÿèƒ½è‡ªåŠ¨è¯†åˆ«æ˜¯å¦åœ¨å¾®å‰ç«¯ç¯å¢ƒä¸­è¿è¡Œ
3. **é€æ˜çš„å‰ç¼€å¤„ç†**ï¼šå¼€å‘è€…æ— éœ€æ‰‹åŠ¨å¤„ç†è·¯å¾„å‰ç¼€ï¼Œç³»ç»Ÿè‡ªåŠ¨å¤„ç†
4. **å‘åå…¼å®¹**ï¼šç‹¬ç«‹è¿è¡Œæ¨¡å¼å®Œå…¨ä¸å—å½±å“
5. **æ˜“äºç»´æŠ¤**ï¼šæ‰€æœ‰è·¯å¾„é…ç½®éƒ½åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œä¾¿äºåç»­ç»´æŠ¤å’Œä¿®æ”¹

ç°åœ¨ï¼Œå½“å¾®åº”ç”¨è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„æ¥å£å’Œé™æ€èµ„æºéƒ½ä¼šè‡ªåŠ¨åŠ ä¸Š `/ragflow/` å‰ç¼€ï¼Œå®Œå…¨æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚