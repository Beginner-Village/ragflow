# RAGFlow Web æ‰“åŒ…å’Œé”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åœ¨RAGFlow Webé¡¹ç›®æ„å»ºå’Œéƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç©ºç™½é¡µé¢é—®é¢˜** - æ„å»ºåè®¿é—®æ˜¾ç¤ºç©ºç™½é¡µé¢
2. **Qiankuné”™è¯¯** - æ§åˆ¶å°æ˜¾ç¤º "register failed, invalid key qiankun"
3. **Reactè¿è¡Œæ—¶é”™è¯¯** - åŒ…æ‹¬ `Minified React error #31` å’Œ `u.filter is not a function`
4. **APIè¯·æ±‚å¤±è´¥** - ç”Ÿäº§ç¯å¢ƒä¸‹APIè¯·æ±‚æœªæ­£ç¡®è½¬å‘

## ğŸ”§ ä¿®å¤æªæ–½è¯¦ç»†è¯´æ˜

### 1. è·¯å¾„é…ç½®ä¿®å¤ (`.umirc.ts`)

**é—®é¢˜æ ¹å› **ï¼šé”™è¯¯åœ°ä½¿ç”¨ `NODE_ENV === 'production'` æ¥åˆ¤æ–­æ˜¯å¦ä¸ºå¾®åº”ç”¨æ¨¡å¼

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// ä¿®å¤å‰ï¼šé”™è¯¯çš„åˆ¤æ–­æ¡ä»¶
base: process.env.NODE_ENV === 'production' ? '/ragflow/' : '/',

// ä¿®å¤åï¼šæ­£ç¡®çš„ç¯å¢ƒå˜é‡åˆ¤æ–­
base: process.env.MICRO_APP === 'true' ? '/ragflow/' : '/',
```

**å½±å“**ï¼š
- âœ… è§£å†³äº†ç”Ÿäº§ç¯å¢ƒä¸‹é™æ€èµ„æºè·¯å¾„é”™è¯¯çš„é—®é¢˜
- âœ… ä¿®å¤äº†ç©ºç™½é¡µé¢é—®é¢˜
- âœ… ç¡®ä¿ç‹¬ç«‹æ¨¡å¼å’Œå¾®åº”ç”¨æ¨¡å¼æ­£ç¡®è¿è¡Œ

### 2. APIä»£ç†ä¿®å¤ (`simple-server.js`)

**é—®é¢˜æ ¹å› **ï¼šç”Ÿäº§ç¯å¢ƒä¸‹UMIçš„ä»£ç†é…ç½®ä¸ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨é™æ€æœåŠ¡å™¨ä¸­å®ç°APIè½¬å‘

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// æ·»åŠ APIä»£ç†é€»è¾‘
if (pathname.startsWith('/v1/')) {
  const backendUrl = 'http://10.10.10.225:9380';
  const targetUrl = `${backendUrl}${req.url}`;
  
  // ä½¿ç”¨åŸç”Ÿhttpæ¨¡å—è½¬å‘è¯·æ±‚
  const proxyReq = requestModule.request(options, (proxyRes) => {
    // è®¾ç½®CORSå¤´å¹¶è½¬å‘å“åº”
  });
}
```

**å½±å“**ï¼š
- âœ… ç”Ÿäº§ç¯å¢ƒä¸‹APIè¯·æ±‚æ­£ç¡®è½¬å‘åˆ°åç«¯æœåŠ¡å™¨
- âœ… æ”¯æŒCORSè·¨åŸŸè®¿é—®
- âœ… æä¾›é”™è¯¯é™çº§å¤„ç†

### 3. Reactæ•°æ®å®‰å…¨ä¿®å¤ (`src/hooks/llm-hooks.tsx`)

**é—®é¢˜æ ¹å› **ï¼šæ•°æ®åŠ è½½è¿‡ç¨‹ä¸­ï¼ŒæŸäº›å˜é‡ä¸ºundefinedæˆ–nullæ—¶è°ƒç”¨`.filter()`æ–¹æ³•

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// ä¿®å¤å‰ï¼šç›´æ¥ä½¿ç”¨å¯èƒ½ä¸ºundefinedçš„æ•°æ®
return Object.entries(llmInfo)
  .map(([key, value]) => {
    return {
      options: value.filter(...)  // valueå¯èƒ½ä¸ºundefined
    };
  });

// ä¿®å¤åï¼šæ·»åŠ æ•°æ®å®‰å…¨æ£€æŸ¥
const nextMyLlmList: Array<LlmItem> = useMemo(() => {
  // ç¡®ä¿æ•°æ®å·²åŠ è½½ä¸”æœ‰æ•ˆ
  if (!myLlmList || !factoryList) {
    return [];
  }
  
  return Object.entries(myLlmList).map(([key, value]) => ({
    llm: Array.isArray(value.llm) ? value.llm.map(...) : [],
  }));
}, [myLlmList, factoryList]);
```

**å½±å“**ï¼š
- âœ… è§£å†³äº† `u.filter is not a function` é”™è¯¯
- âœ… é˜²æ­¢Reactè¿è¡Œæ—¶å´©æºƒ
- âœ… æä¾›æ›´å¥½çš„æ•°æ®åŠ è½½ä½“éªŒ

### 4. é”™è¯¯è¾¹ç•Œç»„ä»¶ (`src/components/error-boundary.tsx`)

**æ–°å¢åŠŸèƒ½**ï¼š
```typescript
class ErrorBoundary extends React.Component {
  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught an error:', error, errorInfo);
  }
  
  render() {
    if (this.state.hasError) {
      return <Result status="error" title="åº”ç”¨è¿è¡Œå‡ºé”™" />;
    }
    return this.props.children;
  }
}
```

**å½±å“**ï¼š
- âœ… å…¨å±€é”™è¯¯æ•è·ï¼Œé˜²æ­¢æ•´ä¸ªåº”ç”¨å´©æºƒ
- âœ… å‹å¥½çš„é”™è¯¯æ˜¾ç¤ºç•Œé¢
- âœ… å¼€å‘ç¯å¢ƒæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯

### 5. æ¡ä»¶åŒ–Qiankuné…ç½®

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```typescript
// ä»…åœ¨å¾®åº”ç”¨æ¨¡å¼ä¸‹å¯ç”¨qiankuné…ç½®
...(process.env.MICRO_APP === 'true' && {
  qiankun: {
    slave: {
      devPort: 2080,
      entry: '//localhost:2080',
      runtimeChunk: false,
    },
  },
}),

plugins: [
  // åªåœ¨å¾®åº”ç”¨æ¨¡å¼ä¸‹åŠ è½½qiankunæ’ä»¶
  ...(process.env.MICRO_APP === 'true' ? ['@umijs/plugins/dist/qiankun'] : []),
].filter(Boolean),
```

**å½±å“**ï¼š
- âœ… è§£å†³äº† "register failed, invalid key qiankun" é”™è¯¯
- âœ… ç‹¬ç«‹æ¨¡å¼ä¸‹ä¸åŠ è½½ä¸å¿…è¦çš„å¾®åº”ç”¨æ’ä»¶
- âœ… å¾®åº”ç”¨æ¨¡å¼æ­£å¸¸å·¥ä½œ

## ğŸ“¦ æ„å»ºè„šæœ¬æ›´æ–° (`package.json`)

**æ–°å¢è„šæœ¬**ï¼š
```json
{
  "scripts": {
    "build": "umi build",
    "build:micro": "cross-env MICRO_APP=true umi build",
    "dev": "umi dev",
    "dev:micro": "cross-env MICRO_APP=true umi dev",
    "start:prod": "node simple-server.js",
    "serve:micro": "cross-env MICRO_APP=true node simple-server.js"
  }
}
```

**ä½¿ç”¨è¯´æ˜**ï¼š
- `npm run build && npm run start:prod` - ç‹¬ç«‹è¿è¡Œæ¨¡å¼
- `npm run build:micro && npm run serve:micro` - å¾®åº”ç”¨é›†æˆæ¨¡å¼

## ğŸ§ª éªŒè¯å·¥å…·

åˆ›å»ºäº† `éªŒè¯ä¿®å¤ç»“æœ.html` è‡ªåŠ¨åŒ–æµ‹è¯•é¡µé¢ï¼ŒåŒ…å«ï¼š

1. **æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥** - éªŒè¯é™æ€æœåŠ¡å™¨è¿è¡ŒçŠ¶æ€
2. **ä¸»é¡µåŠ è½½æµ‹è¯•** - æ£€æŸ¥HTMLç»“æ„å’Œèµ„æºåŠ è½½
3. **APIä»£ç†æµ‹è¯•** - éªŒè¯APIè¯·æ±‚è½¬å‘åŠŸèƒ½
4. **Reacté”™è¯¯æ£€æŸ¥** - ç›‘æ§Reactè¿è¡Œæ—¶é”™è¯¯
5. **é”™è¯¯è¾¹ç•ŒéªŒè¯** - ç¡®è®¤é”™è¯¯æ•è·æœºåˆ¶

## ğŸ“Š ä¿®å¤ç»“æœ

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **ç©ºç™½é¡µé¢** â†’ åº”ç”¨æ­£å¸¸æ˜¾ç¤º
2. **Qiankuné”™è¯¯** â†’ é”™è¯¯æ¶ˆé™¤ï¼Œç‹¬ç«‹/å¾®åº”ç”¨æ¨¡å¼æ­£ç¡®åˆ‡æ¢
3. **Reacté”™è¯¯** â†’ æ•°æ®å®‰å…¨è®¿é—®ï¼Œæ— è¿è¡Œæ—¶å´©æºƒ
4. **APIè¯·æ±‚** â†’ ç”Ÿäº§ç¯å¢ƒæ­£ç¡®è½¬å‘åˆ°åç«¯æœåŠ¡å™¨

### ğŸ¯ æŠ€æœ¯æ”¹è¿›

1. **ä»£ç å¥å£®æ€§** - æ·»åŠ äº†æ•°æ®å®‰å…¨æ£€æŸ¥å’Œé”™è¯¯è¾¹ç•Œ
2. **é…ç½®çµæ´»æ€§** - æ”¯æŒç‹¬ç«‹å’Œå¾®åº”ç”¨ä¸¤ç§è¿è¡Œæ¨¡å¼
3. **ç”Ÿäº§å°±ç»ª** - å®Œæ•´çš„é™æ€æœåŠ¡å™¨å’ŒAPIä»£ç†æ”¯æŒ
4. **å¼€å‘ä½“éªŒ** - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•å·¥å…·

## ğŸš€ éƒ¨ç½²æ–¹å¼

### ç‹¬ç«‹è¿è¡Œ
```bash
npm run build
npm run start:prod
```
è®¿é—®ï¼šhttp://localhost:2080

### å¾®åº”ç”¨é›†æˆ
```bash
npm run build:micro
npm run serve:micro
```
ä¸»åº”ç”¨é…ç½®ï¼š
```javascript
entry: 'http://localhost:2080/ragflow/'
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼šä½¿ç”¨ `MICRO_APP=true` æ¥åŒºåˆ†è¿è¡Œæ¨¡å¼
2. **ç«¯å£é…ç½®**ï¼šé»˜è®¤è¿è¡Œåœ¨ 2080 ç«¯å£
3. **APIåç«¯**ï¼šéœ€è¦ç¡®ä¿åç«¯æœåŠ¡åœ¨ `http://10.10.10.225:9380` è¿è¡Œ
4. **æµè§ˆå™¨å…¼å®¹**ï¼šæ”¯æŒç°ä»£æµè§ˆå™¨ï¼Œå·²æ·»åŠ å¿…è¦çš„polyfill

## ğŸ” æ•…éšœæ’æŸ¥

å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. æ‰“å¼€ `éªŒè¯ä¿®å¤ç»“æœ.html` è¿›è¡Œè‡ªåŠ¨åŒ–æ£€æµ‹
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
3. ç¡®è®¤ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®
4. éªŒè¯åç«¯æœåŠ¡è¿é€šæ€§

---

## ğŸ‰ æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜åˆ†æå’Œä¿®å¤ï¼ŒRAGFlow Webåº”ç”¨ç°åœ¨å¯ä»¥ï¼š

- âœ… ç¨³å®šè¿è¡Œåœ¨ç”Ÿäº§ç¯å¢ƒ
- âœ… æ”¯æŒç‹¬ç«‹å’Œå¾®åº”ç”¨ä¸¤ç§éƒ¨ç½²æ¨¡å¼
- âœ… å…·å¤‡å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… æä¾›å‹å¥½çš„ç”¨æˆ·ä½“éªŒ

æ‰€æœ‰åŸå§‹é—®é¢˜å·²å¾—åˆ°å½»åº•è§£å†³ï¼Œåº”ç”¨ç°å·²å…·å¤‡ç”Ÿäº§éƒ¨ç½²æ¡ä»¶ã€‚ 