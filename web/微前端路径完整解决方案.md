# RAGFlow å¾®å‰ç«¯è·¯å¾„å®Œæ•´è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

å°†RAGFlow Reactå‰ç«¯ä½œä¸ºå¾®åº”ç”¨é›†æˆåˆ°Vueä¸»åº”ç”¨ä¸­æ—¶ï¼Œéœ€è¦ç¡®ä¿å½“è®¿é—® `/ragflow/#/knowledge` è·¯ç”±æ—¶ï¼Œæ‰€æœ‰APIè¯·æ±‚å’Œé™æ€èµ„æºéƒ½è‡ªåŠ¨åŠ ä¸Š `/ragflow/` å‰ç¼€ã€‚

## è§£å†³æ–¹æ¡ˆæ¦‚è§ˆ

é€šè¿‡ä»¥ä¸‹å››ä¸ªå±‚é¢çš„ä¿®æ”¹ï¼Œå®ç°äº†å®Œæ•´çš„è·¯å¾„å‰ç¼€æ”¯æŒï¼š

1. **å‰ç«¯åŠ¨æ€è·¯å¾„æ£€æµ‹** - æ™ºèƒ½è¯†åˆ«è¿è¡Œç¯å¢ƒ
2. **æ—©æœŸå…¬å…±è·¯å¾„è®¾ç½®** - ç¡®ä¿webpack chunkæ­£ç¡®åŠ è½½  
3. **APIè¯·æ±‚æ‹¦æˆª** - è‡ªåŠ¨æ·»åŠ APIå‰ç¼€
4. **æœåŠ¡å™¨ç«¯æ”¯æŒ** - HTMLå’Œé™æ€èµ„æºè·¯å¾„å¤„ç†

## è¯¦ç»†å®ç°

### 1. å‰ç«¯è·¯å¾„æ£€æµ‹å·¥å…· (`src/utils/path-util.ts`)

```typescript
// æ™ºèƒ½æ£€æµ‹æ˜¯å¦éœ€è¦ragflowå‰ç¼€
export function shouldUseRagflowPrefix(): boolean {
  // qiankunç¯å¢ƒ
  if (window.__POWERED_BY_QIANKUN__) return true;
  
  // URLè·¯å¾„æ£€æµ‹
  const currentPath = window.location.pathname;
  if (currentPath.includes('/ragflow/') || currentPath.endsWith('/ragflow')) {
    return true;
  }
  
  // å¼€å‘ç«¯å£æ£€æµ‹
  const currentPort = window.location.port;
  if (currentPort === '2080' && currentPath.includes('ragflow')) {
    return true;
  }
  
  // nginxä»£ç†æ£€æµ‹
  if (!currentPort && currentPath.startsWith('/ragflow')) {
    return true;
  }
  
  return false;
}

export function getApiPrefix(): string {
  return shouldUseRagflowPrefix() ? '/ragflow' : '';
}
```

### 2. æ—©æœŸå…¬å…±è·¯å¾„è®¾ç½® (`public/set-public-path.js`)

åœ¨webpackè¿è¡Œå‰è®¾ç½®publicPathï¼Œç¡®ä¿å¼‚æ­¥chunkæ­£ç¡®åŠ è½½ï¼š

```javascript
(function() {
  'use strict';
  
  function shouldUseRagflowPrefix() {
    // ... æ£€æµ‹é€»è¾‘åŒä¸Š
  }
  
  // è®¾ç½®å…¬å…±è·¯å¾„
  const publicPath = shouldUseRagflowPrefix() ? '/ragflow/' : '/';
  
  // è®¾ç½®webpackå…¬å…±è·¯å¾„
  window.__webpack_public_path__ = publicPath;
  window.RAGFLOW_PUBLIC_PATH = publicPath;
  
  console.log('ğŸ”§ [Very Early] è®¾ç½® publicPath ä¸º', publicPath);
})();
```

### 3. APIè¯·æ±‚æ‹¦æˆª (`src/utils/request.ts`)

```typescript
// è¯·æ±‚æ‹¦æˆªå™¨ä¸­æ·»åŠ å‰ç¼€å¤„ç†
request.interceptors.request.use((config) => {
  const apiPrefix = getApiPrefix();
  if (apiPrefix && config.url && !config.url.startsWith('http')) {
    config.url = `${apiPrefix}${config.url}`;
  }
  return config;
});
```

### 4. UMIé…ç½®æ›´æ–° (`.umirc.ts`)

```typescript
export default defineConfig({
  // è¿è¡Œæ—¶åŠ¨æ€publicPath
  runtimePublicPath: { scriptTag: true },
  
  // æ—©æœŸåŠ è½½publicPathè®¾ç½®è„šæœ¬
  headScripts: [
    { src: '/set-public-path.js' },
    // ... å…¶ä»–è„šæœ¬
  ],
  
  // å…¶ä»–é…ç½®...
});
```

### 5. åº”ç”¨å…¥å£é…ç½® (`src/app.tsx`)

```typescript
// åŠ¨æ€è®¾ç½®è¿è¡Œæ—¶å…¬å…±è·¯å¾„ - å¿…é¡»åœ¨æ‰€æœ‰importsä¹‹å‰
if (typeof window !== 'undefined') {
  if (shouldUseRagflowPrefix()) {
    // è®¾ç½®å¤šä¸ªå¯èƒ½çš„publicPathå˜é‡
    (window as any).__webpack_public_path__ = '/ragflow/';
    if (typeof __webpack_public_path__ !== 'undefined') {
      __webpack_public_path__ = '/ragflow/';
    }
    console.log('ğŸ”§ åŠ¨æ€è®¾ç½® publicPath ä¸º /ragflow/');
  }
}
```

### 6. æœåŠ¡å™¨ç«¯æ”¯æŒ (`simple-server.js`)

```javascript
function serveIndexHtml(res, pathname) {
  fs.readFile(indexPath, 'utf8', (err, data) => {
    let htmlContent = data;
    
    // å¾®åº”ç”¨æ¨¡å¼ï¼šä¿®æ”¹HTMLä¸­çš„èµ„æºè·¯å¾„
    if (pathname && pathname.startsWith('/ragflow')) {
      console.log('ğŸ”§ ä¸ºå¾®åº”ç”¨æ¨¡å¼ä¿®æ”¹HTMLèµ„æºè·¯å¾„');
      
      // ä¿®æ”¹CSSã€JSã€å›¾æ ‡ç­‰èµ„æºè·¯å¾„
      htmlContent = htmlContent.replace(/href="\/([^"]+\.css)"/g, 'href="/ragflow/$1"');
      htmlContent = htmlContent.replace(/src="\/([^"]+\.js)"/g, 'src="/ragflow/$1"');
      htmlContent = htmlContent.replace(/href="\/([^"]+\.(ico|svg|png))"/g, 'href="/ragflow/$1"');
      
      // ç¡®ä¿set-public-path.jsä¸è¢«æ·»åŠ å‰ç¼€
      htmlContent = htmlContent.replace('src="/ragflow/set-public-path.js"', 'src="/set-public-path.js"');
      
      // æ·»åŠ baseæ ‡ç­¾
      htmlContent = htmlContent.replace('<head>', '<head>\n  <base href="/ragflow/">');
      
      // æ·»åŠ æ—©æœŸpublicPathè„šæœ¬
      const publicPathScript = `
  <script>
    window.__webpack_public_path__ = '/ragflow/';
    console.log('ğŸ”§ [Early] è®¾ç½® publicPath ä¸º /ragflow/');
  </script>`;
      htmlContent = htmlContent.replace('<head>', '<head>' + publicPathScript);
    }
    
    res.end(htmlContent);
  });
}

// APIä»£ç†æ”¯æŒ
const isApiRequest = pathname.startsWith('/v1/') || pathname.startsWith('/ragflow/v1/');
if (isApiRequest) {
  let apiPath = req.url;
  if (pathname.startsWith('/ragflow/v1/')) {
    apiPath = req.url.replace('/ragflow', '');
  }
  // è½¬å‘åˆ°åç«¯...
}
```

## æµ‹è¯•éªŒè¯

### 1. ç‹¬ç«‹è®¿é—®æ¨¡å¼
```bash
curl 'http://localhost:2080/' | grep -E '(href=|src=)'
# è¾“å‡ºï¼šæ‰€æœ‰èµ„æºè·¯å¾„ä¸å¸¦å‰ç¼€
# href="/logo.svg", src="/umi.xxx.js"
```

### 2. å¾®åº”ç”¨æ¨¡å¼  
```bash
curl 'http://localhost:2080/ragflow/' | grep -E '(href=|src=)'
# è¾“å‡ºï¼šæ‰€æœ‰èµ„æºè·¯å¾„å¸¦ragflowå‰ç¼€
# href="/ragflow/logo.svg", src="/ragflow/umi.xxx.js"
```

### 3. APIè¯·æ±‚æµ‹è¯•
```bash
curl 'http://localhost:2080/ragflow/v1/user/info'
# æ­£ç¡®è½¬å‘åˆ°åç«¯ï¼šhttp://10.10.10.225:9380/v1/user/info
```

## éƒ¨ç½²é…ç½®

### Nginxé…ç½®
```nginx
location /ragflow/ {
    proxy_pass http://10.10.10.215:2080;  # æ³¨æ„ï¼šä¸è¦åœ¨åé¢åŠ è·¯å¾„
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### ä¸»åº”ç”¨é›†æˆé…ç½®
```javascript
// qiankuné…ç½®
registerMicroApps([
  {
    name: 'ragflow',
    entry: '//your-domain.com/ragflow/',
    container: '#ragflow-container',
    activeRule: '/ragflow',
  }
]);
```

## æ”¯æŒçš„ç¯å¢ƒ

- âœ… **qiankunå¾®å‰ç«¯**ï¼šè‡ªåŠ¨æ£€æµ‹ `window.__POWERED_BY_QIANKUN__`
- âœ… **ç‹¬ç«‹è®¿é—®**ï¼š`http://localhost:2080/` 
- âœ… **å¾®åº”ç”¨è®¿é—®**ï¼š`http://localhost:2080/ragflow/`
- âœ… **nginxä»£ç†**ï¼š`https://domain.com/ragflow/`
- âœ… **å¼€å‘ç¯å¢ƒ**ï¼šç«¯å£2080è‡ªåŠ¨æ£€æµ‹

## è§£å†³çš„é—®é¢˜

1. âœ… **é™æ€èµ„æºè·¯å¾„**ï¼šCSSã€JSã€å›¾æ ‡ç­‰æ–‡ä»¶æ­£ç¡®åŠ è½½
2. âœ… **å¼‚æ­¥chunkåŠ è½½**ï¼šwebpackåŠ¨æ€å¯¼å…¥çš„ä»£ç å—æ­£ç¡®è·¯å¾„
3. âœ… **APIè¯·æ±‚å‰ç¼€**ï¼šæ‰€æœ‰APIè°ƒç”¨è‡ªåŠ¨æ·»åŠ  `/ragflow/` å‰ç¼€
4. âœ… **è·¯ç”±å…¼å®¹**ï¼šæ”¯æŒç‹¬ç«‹è®¿é—®å’Œå¾®åº”ç”¨ä¸¤ç§æ¨¡å¼
5. âœ… **ç¯å¢ƒè‡ªé€‚åº”**ï¼šæ™ºèƒ½æ£€æµ‹è¿è¡Œç¯å¢ƒæ— éœ€æ‰‹åŠ¨é…ç½®

## å…³é”®æŠ€æœ¯ç‚¹

1. **æ—©æœŸè·¯å¾„è®¾ç½®**ï¼šåœ¨webpackè¿è¡Œå‰é€šè¿‡ç‹¬ç«‹è„šæœ¬è®¾ç½®publicPath
2. **å¤šå±‚è·¯å¾„æ£€æµ‹**ï¼šç»“åˆqiankunã€URLã€ç«¯å£ç­‰å¤šç§æ£€æµ‹æ–¹å¼
3. **HTMLåŠ¨æ€ä¿®æ”¹**ï¼šæœåŠ¡å™¨ç«¯æ ¹æ®è®¿é—®è·¯å¾„åŠ¨æ€ä¿®æ”¹èµ„æºå¼•ç”¨
4. **APIæ™ºèƒ½ä»£ç†**ï¼šæ”¯æŒæœ‰å‰ç¼€å’Œæ— å‰ç¼€ä¸¤ç§APIæ ¼å¼çš„è½¬å‘

æ­¤è§£å†³æ–¹æ¡ˆç¡®ä¿äº†RAGFlowå¯ä»¥å®Œç¾è¿è¡Œåœ¨å¾®å‰ç«¯ç¯å¢ƒä¸­ï¼ŒåŒæ—¶ä¿æŒç‹¬ç«‹è®¿é—®çš„å…¼å®¹æ€§ã€‚ 