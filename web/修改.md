æˆ‘ä½¿ç”¨ qiankun å°† RAGFlow çš„ React å‰ç«¯åµŒå…¥åˆ° Vue ä¸»åº”ç”¨ä¸­

æˆ‘/Users/linan/code/agent-h5/agent-h5-dev/webæ˜¯ragflowçš„webuiçš„æ ·å¼



æˆ‘æ€ä¹ˆä¿è¯RAGFlow çš„ React å‰ç«¯çš„Vue ä¸»åº”ç”¨ï¼Œæ ·å¼å’Œæ¸²æŸ“ä¸ä¼šå¾ˆå†²çªå¥‡æ€ªï¼Ÿç»™æˆ‘ä¸€ä¸ªmarkdownçš„è®¾è®¡æ–¹æ¡ˆ


å‚è€ƒèµ„æ–™å¦‚ä¸‹
## å¾®å‰ç«¯æ¶æ„æ–¹æ¡ˆè¯¦è§£

### ä»€ä¹ˆæ˜¯ qiankun

qiankun æ˜¯ä¸€ä¸ªåŸºäº single-spa çš„**å¾®å‰ç«¯å®ç°åº“**ï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ„å»ºç”Ÿäº§å¯ç”¨çš„å¾®å‰ç«¯æ¶æ„ç³»ç»Ÿ[1]ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **æŠ€æœ¯æ ˆæ— å…³**ï¼šä¸»åº”ç”¨å’Œå­åº”ç”¨å¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆ
- **ç®€å•æ˜“ç”¨**ï¼šæ¥å…¥åƒä½¿ç”¨ iframe ä¸€æ ·ç®€å•ï¼Œä½†æ¯” iframe æ›´å¼ºå¤§
- **æ ·å¼éš”ç¦»**ï¼šè‡ªåŠ¨å¤„ç†ä¸åŒåº”ç”¨é—´çš„æ ·å¼å†²çª
- **JS æ²™ç®±**ï¼šä¿è¯åº”ç”¨é—´çš„è¿è¡Œæ—¶éš”ç¦»[2]

### æ‚¨çš„å…·ä½“æ–¹æ¡ˆï¼šVue ä¸»åº”ç”¨ + React å­åº”ç”¨

å¯¹äºæ‚¨çš„éœ€æ±‚ï¼ˆVue è‡ªç ”å¹³å°ä½œä¸ºä¸»åº”ç”¨ï¼ŒRAGFlow React å‰ç«¯ä½œä¸ºå­åº”ç”¨ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¾®å‰ç«¯åº”ç”¨åœºæ™¯ã€‚

## è¯¦ç»†é…ç½®æ­¥éª¤

### ä¸€ã€ä¸»åº”ç”¨é…ç½®ï¼ˆVue å¹³å°ï¼‰

#### 1. å®‰è£… qiankun
```bash
npm install qiankun --save
# æˆ–è€…
yarn add qiankun
```

#### 2. æ³¨å†Œå¾®åº”ç”¨å¹¶å¯åŠ¨
```javascript
// åœ¨ä¸»åº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼ˆå¦‚ main.jsï¼‰ä¸­
import { registerMicroApps, start } from 'qiankun';

// æ³¨å†Œå¾®åº”ç”¨
registerMicroApps([
  {
    name: 'ragflow-react',           // å¾®åº”ç”¨åç§°
    entry: '//localhost:3000',       // RAGFlow React åº”ç”¨çš„å…¥å£åœ°å€
    container: '#ragflow-container', // å¾®åº”ç”¨æŒ‚è½½çš„å®¹å™¨
    activeRule: '/ragflow',          // è·¯ç”±åŒ¹é…è§„åˆ™
  }
]);

// å¯åŠ¨ qiankun
start();
```

#### 3. åœ¨ Vue ç»„ä»¶ä¸­æä¾›å®¹å™¨
```vue

  
    
    
      
    
    
    
    
  

```

### äºŒã€å­åº”ç”¨é…ç½®ï¼ˆRAGFlow React åº”ç”¨ï¼‰

#### 1. åœ¨ src ç›®å½•åˆ›å»º public-path.js æ–‡ä»¶
```javascript
// src/public-path.js
// è¿™ä¸ªæ–‡ä»¶ç”¨äºä¿®æ”¹è¿è¡Œæ—¶çš„ publicPath
if (window.__POWERED_BY_QIANKUN__) {
  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;
}
```

**æ³¨é‡Šè¯´æ˜**ï¼š
- `window.__POWERED_BY_QIANKUN__`ï¼šqiankun ä¼šåœ¨åŠ è½½å­åº”ç”¨æ—¶è®¾ç½®è¿™ä¸ªå…¨å±€å˜é‡
- `__webpack_public_path__`ï¼šwebpack çš„è¿è¡Œæ—¶å…¬å…±è·¯å¾„ï¼Œç”¨äºåŠ è½½é™æ€èµ„æº
- `window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__`ï¼šqiankun æ³¨å…¥çš„å…¬å…±è·¯å¾„

#### 2. è®¾ç½®è·¯ç”± base
```jsx
// åœ¨ React è·¯ç”±é…ç½®ä¸­

  {/* è·¯ç”±å†…å®¹ */}

```

**æ³¨é‡Šè¯´æ˜**ï¼š
- `basename`ï¼šReact Router çš„åŸºç¡€è·¯å¾„
- å½“åœ¨ qiankun ä¸­è¿è¡Œæ—¶ï¼Œè®¾ç½®ä¸º `/ragflow`ï¼ˆä¸ä¸»åº”ç”¨ä¸­çš„ activeRule å¯¹åº”ï¼‰
- ç‹¬ç«‹è¿è¡Œæ—¶ä¿æŒæ ¹è·¯å¾„ `/`

#### 3. ä¿®æ”¹å…¥å£æ–‡ä»¶ï¼ˆindex.jsï¼‰
```javascript
// src/index.js
import './public-path';  // å¿…é¡»åœ¨æœ€é¡¶éƒ¨å¼•å…¥
import React from 'react';
import ReactDOM from 'react-dom';
import App from './App';

// æ¸²æŸ“å‡½æ•°
function render(props) {
  const { container } = props;
  ReactDOM.render(
    , 
    container ? container.querySelector('#root') : document.querySelector('#root')
  );
}

// ç‹¬ç«‹è¿è¡Œæ—¶
if (!window.__POWERED_BY_QIANKUN__) {
  render({});
}

// å¯¼å‡ºç”Ÿå‘½å‘¨æœŸå‡½æ•°ç»™ qiankun
export async function bootstrap() {
  console.log('[react] react app bootstraped');
}

export async function mount(props) {
  console.log('[react] props from main framework', props);
  render(props);
}

export async function unmount(props) {
  const { container } = props;
  ReactDOM.unmountComponentAtNode(
    container ? container.querySelector('#root') : document.querySelector('#root')
  );
}
```

**æ³¨é‡Šè¯´æ˜**ï¼š
- **ç”Ÿå‘½å‘¨æœŸå‡½æ•°**ï¼š
  - `bootstrap`ï¼šåº”ç”¨åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼ˆåªè°ƒç”¨ä¸€æ¬¡ï¼‰
  - `mount`ï¼šåº”ç”¨æ¯æ¬¡åŠ è½½æ—¶è°ƒç”¨
  - `unmount`ï¼šåº”ç”¨æ¯æ¬¡å¸è½½æ—¶è°ƒç”¨
- **render å‡½æ•°**ï¼šç»Ÿä¸€çš„æ¸²æŸ“é€»è¾‘ï¼Œæ”¯æŒç‹¬ç«‹è¿è¡Œå’ŒåµŒå…¥è¿è¡Œ
- **container**ï¼šä»ä¸»åº”ç”¨ä¼ é€’çš„å®¹å™¨å…ƒç´ 

#### 4. ä¿®æ”¹ webpack é…ç½®

**å®‰è£…æ’ä»¶**ï¼š
```bash
npm install -D @rescripts/cli
```

**åˆ›å»º .rescriptsrc.js**ï¼š
```javascript
// .rescriptsrc.js
const { name } = require('./package');

module.exports = {
  webpack: (config) => {
    // é…ç½®åº”ç”¨åç§°å’Œè¾“å‡ºæ ¼å¼
    config.output.library = `${name}-[name]`;
    config.output.libraryTarget = 'umd';  // è¾“å‡ºä¸º UMD æ ¼å¼
    config.output.jsonpFunction = `webpackJsonp_${name}`;
    config.output.globalObject = 'window';
    
    return config;
  },
  
  devServer: (_) => {
    const config = _;
    
    // é…ç½® CORS å…è®¸è·¨åŸŸè®¿é—®
    config.headers = {
      'Access-Control-Allow-Origin': '*',
    };
    config.historyApiFallback = true;
    config.hot = false;
    config.watchContentBase = false;
    config.liveReload = false;
    
    return config;
  },
};
```

**æ³¨é‡Šè¯´æ˜**ï¼š
- **UMD æ ¼å¼**ï¼šé€šç”¨æ¨¡å—å®šä¹‰ï¼Œæ”¯æŒå¤šç§æ¨¡å—ç³»ç»Ÿ
- **CORS é…ç½®**ï¼šå…è®¸ä¸»åº”ç”¨è·¨åŸŸè®¿é—®å­åº”ç”¨èµ„æº
- **library é…ç½®**ï¼šä¸ºå­åº”ç”¨è®¾ç½®å”¯ä¸€çš„åº“åç§°
- **jsonpFunction**ï¼šé¿å…å¤šä¸ªåº”ç”¨é—´çš„ webpack è¿è¡Œæ—¶å†²çª

#### 5. ä¿®æ”¹ package.json
```json
{
  "scripts": {
    "start": "rescripts start",
    "build": "rescripts build",
    "test": "rescripts test"
  }
}
```

## æ ¸å¿ƒæ¦‚å¿µè§£é‡Š

### 1. HTML Entry
qiankun é‡‡ç”¨ HTML Entry çš„æ–¹å¼åŠ è½½å¾®åº”ç”¨ï¼Œè¿™æ„å‘³ç€ï¼š
- ä¸»åº”ç”¨åªéœ€è¦çŸ¥é“å­åº”ç”¨çš„ HTML åœ°å€
- qiankun ä¼šè‡ªåŠ¨è§£æ HTML ä¸­çš„ JS å’Œ CSS èµ„æº
- ç›¸æ¯” JS Entryï¼Œæ›´åŠ çµæ´»å’Œæ˜“äºç†è§£[3]

### 2. æ²™ç®±éš”ç¦»
qiankun æä¾›äº†å¤šç§æ²™ç®±éš”ç¦»æœºåˆ¶ï¼š
- **JS æ²™ç®±**ï¼šéš”ç¦»ä¸åŒåº”ç”¨çš„ JavaScript æ‰§è¡Œç¯å¢ƒ
- **CSS æ²™ç®±**ï¼šé˜²æ­¢æ ·å¼å†²çªå’Œæ±¡æŸ“[1]

### 3. ç”Ÿå‘½å‘¨æœŸç®¡ç†
é€šè¿‡å¯¼å‡ºçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œqiankun å¯ä»¥ï¼š
- æ§åˆ¶åº”ç”¨çš„åŠ è½½å’Œå¸è½½
- ç®¡ç†åº”ç”¨çŠ¶æ€
- å®ç°åº”ç”¨é—´çš„é€šä¿¡[4]

## å®æ–½å»ºè®®

### 1. å¼€å‘ç¯å¢ƒé…ç½®
```javascript
// ä¸»åº”ç”¨ä¸­ï¼Œæ ¹æ®ç¯å¢ƒé…ç½®ä¸åŒçš„å…¥å£åœ°å€
const isDev = process.env.NODE_ENV === 'development';
const ragflowEntry = isDev ? '//localhost:3000' : '//your-production-domain.com';
```

### 2. è·¯ç”±é…ç½®
ç¡®ä¿ Vue ä¸»åº”ç”¨çš„è·¯ç”±é…ç½®åŒ…å«å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼š
```javascript
// Vue è·¯ç”±é…ç½®
{
  path: '/ragflow/*',
  component: () => import('@/views/MicroAppContainer.vue')
}
```

### 3. é€šä¿¡æ–¹æ¡ˆ
å¦‚æœéœ€è¦ä¸»åº”ç”¨å’Œå­åº”ç”¨é€šä¿¡ï¼Œå¯ä»¥ä½¿ç”¨ qiankun æä¾›çš„é€šä¿¡æœºåˆ¶ï¼š
```javascript
// ä¸»åº”ç”¨å‘å­åº”ç”¨ä¼ é€’æ•°æ®
registerMicroApps([
  {
    name: 'ragflow-react',
    entry: '//localhost:3000',
    container: '#ragflow-container',
    activeRule: '/ragflow',
    props: {
      // ä¼ é€’ç»™å­åº”ç”¨çš„æ•°æ®
      userInfo: { name: 'admin' },
      token: 'your-token'
    }
  }
]);
```

è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è®©æ‚¨åœ¨ä¿æŒç°æœ‰ Vue å¹³å°æ¶æ„çš„åŒæ—¶ï¼Œæ— ç¼é›†æˆ RAGFlow çš„ React å‰ç«¯ï¼Œå®ç°çœŸæ­£çš„æŠ€æœ¯æ ˆæ— å…³çš„å¾®å‰ç«¯æ¶æ„[5][6]ã€‚

[1] https://qiankun.umijs.org/zh/guide
[2] https://qiankun.umijs.org/zh
[3] https://juejin.cn/post/7242623208841592869
[4] https://juejin.cn/post/7263457589810708537
[5] https://juejin.cn/post/7189465266932154425
[6] https://blog.csdn.net/qq_38209578/article/details/129154862
[7] https://qiankun.umijs.org/zh/guide/tutorial
[8] https://zenn.dev/kun432/scraps/5b8547c6aa1c95
[9] https://k.jianxiecloud.com/web/qiankun/
[10] https://blog.csdn.net/f80407515/article/details/147092204
[11] https://qiita.com/syukan3/items/518eb2cd3e32e1417880
[12] https://patents.google.com/patent/CN113986226A/zh
[13] https://blog.csdn.net/Python_cocola/article/details/147848306
[14] https://github.com/xiaohuoni/qiankun-vue-react-demo
[15] https://github.com/liyongning/qiankun
[16] https://comate.baidu.com/zh/page/6wt6rbq5tma
[17] https://blog.csdn.net/weixin_43503080/article/details/131814068
[18] https://www.cnblogs.com/crispyChicken/p/18721394
[19] https://github.com/infiniflow/ragflow/issues/5149
[20] https://juejin.cn/post/7279242388999127094
[21] https://blog.csdn.net/Yi_qian1000/article/details/135261522
[22] https://github.com/infiniflow/ragflow/issues/8568
[23] https://juejin.cn/post/7090191821204095006
[24] https://juejin.cn/post/7210746685802512443
[25] https://blog.csdn.net/m0_67556466/article/details/130490322
[26] https://juejin.cn/post/7106783544739332109
[27] https://everfind.github.io/courses/webpack/micro-frontend.html
[28] https://blog.csdn.net/weixin_44999830/article/details/138576515
[29] https://juejin.cn/post/7051086216594194462
[30] https://blog.csdn.net/jyl919221lc/article/details/130110455
[31] https://blog.csdn.net/Amireux_Cx330/article/details/144664079
[32] https://www.cnblogs.com/smileZAZ/p/18548321
[33] https://blog.csdn.net/cn_jz9527/article/details/133084919
[34] https://jackchoumine.github.io/webpack/%E6%A8%A1%E5%9D%97%E8%81%94%E9%82%A6%E5%AE%9E%E7%8E%B0%E5%BE%AE%E5%89%8D%E7%AB%AF.html
[35] https://juejin.cn/post/7078272210019811359
[36] https://www.cnblogs.com/fozero/p/17717323.html
[37] https://github.com/yuzhanglong/mf-lite
[38] https://github.com/a1029563229/blogs/blob/master/BestPractices/qiankun/Communication.md



# RAGFlow React å­åº”ç”¨é›†æˆè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

å°†åŸºäº UMI 4.0 + React + TypeScript + TailwindCSS çš„ RAGFlow å‰ç«¯ä½œä¸ºå¾®å‰ç«¯å­åº”ç”¨ï¼Œé›†æˆåˆ°åŸºäº YNET æ¡†æ¶çš„ Vue ä¸»åº”ç”¨ä¸­ï¼Œç¡®ä¿æ ·å¼éš”ç¦»ã€æ¸²æŸ“éš”ç¦»å’ŒåŠŸèƒ½å®Œæ•´æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒæŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. æ ·å¼å†²çªé—®é¢˜

#### æŒ‘æˆ˜åˆ†æ
- **TailwindCSS å…¨å±€æ ·å¼**ï¼šå¯èƒ½æ±¡æŸ“ä¸»åº”ç”¨æ ·å¼
- **Antd ç»„ä»¶æ ·å¼**ï¼šä¸ä¸»åº”ç”¨UIç»„ä»¶åº“å†²çª
- **Radix UI æ ·å¼**ï¼šå¯èƒ½å½±å“ä¸»åº”ç”¨å¸ƒå±€
- **å…¨å±€CSS Reset**ï¼šå¯èƒ½é‡ç½®ä¸»åº”ç”¨æ ·å¼

#### è§£å†³æ–¹æ¡ˆ

##### 1.1 CSS å‘½åç©ºé—´éš”ç¦»
```css
/* ä¸º RAGFlow åº”ç”¨æ·»åŠ ç»Ÿä¸€å‰ç¼€ */
.ragflow-app {
  /* æ‰€æœ‰ RAGFlow æ ·å¼éƒ½åœ¨æ­¤å‘½åç©ºé—´ä¸‹ */
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
  
  /* é‡ç½®å¯èƒ½å†²çªçš„æ ·å¼ */
  * {
    box-sizing: border-box;
  }
}

/* TailwindCSS å‰ç¼€é…ç½® */
.ragflow-app .tw-container { /* Tailwindæ ·å¼ */ }
.ragflow-app .tw-flex { /* Tailwindæ ·å¼ */ }
```

##### 1.2 TailwindCSS é…ç½®éš”ç¦»
```javascript
// web/tailwind.config.js ä¿®æ”¹
module.exports = {
  // æ·»åŠ å‰ç¼€ï¼Œé¿å…æ ·å¼å†²çª
  prefix: 'tw-',
  // é™åˆ¶ä½œç”¨åŸŸ
  important: '.ragflow-app',
  content: [
    './src/**/*.{js,ts,jsx,tsx}',
  ],
  theme: {
    extend: {
      // è‡ªå®šä¹‰æ ·å¼é…ç½®
    },
  },
  corePlugins: {
    // ç¦ç”¨å¯èƒ½å†²çªçš„æ ¸å¿ƒæ’ä»¶
    preflight: false, // ç¦ç”¨CSSé‡ç½®
  },
}
```

##### 1.3 Antd æ ·å¼éš”ç¦»
```typescript
// web/src/app.tsx
import { ConfigProvider } from 'antd';

export function rootContainer(container: React.ReactElement) {
  return (
    <ConfigProvider
      prefixCls="ragflow-ant" // æ·»åŠ å‰ç¼€
      theme={{
        cssVar: true, // å¯ç”¨CSSå˜é‡
        hashed: true, // å¯ç”¨æ ·å¼å“ˆå¸Œ
      }}
    >
      <div className="ragflow-app">
        {container}
      </div>
    </ConfigProvider>
  );
}
```

### 2. JavaScript æ²™ç®±éš”ç¦»

#### 2.1 å…¨å±€å˜é‡éš”ç¦»
```typescript
// web/src/utils/sandbox.ts
class GlobalVariableManager {
  private originalGlobals: Map<string, any> = new Map();
  
  // ä¿å­˜å¯èƒ½å†²çªçš„å…¨å±€å˜é‡
  saveGlobals() {
    const conflictKeys = ['$', 'jQuery', 'React', 'ReactDOM', 'antd'];
    conflictKeys.forEach(key => {
      if (window[key]) {
        this.originalGlobals.set(key, window[key]);
      }
    });
  }
  
  // æ¢å¤å…¨å±€å˜é‡
  restoreGlobals() {
    this.originalGlobals.forEach((value, key) => {
      window[key] = value;
    });
  }
}

export const globalManager = new GlobalVariableManager();
```

#### 2.2 äº‹ä»¶ç›‘å¬å™¨éš”ç¦»
```typescript
// web/src/utils/eventManager.ts
class EventManager {
  private eventListeners: Array<{
    element: Element | Window | Document;
    type: string;
    listener: EventListener;
  }> = [];
  
  addEventListener(element: Element | Window | Document, type: string, listener: EventListener) {
    element.addEventListener(type, listener);
    this.eventListeners.push({ element, type, listener });
  }
  
  removeAllListeners() {
    this.eventListeners.forEach(({ element, type, listener }) => {
      element.removeEventListener(type, listener);
    });
    this.eventListeners = [];
  }
}

export const eventManager = new EventManager();
```

### 3. è·¯ç”±éš”ç¦»é…ç½®

#### 3.1 RAGFlow è·¯ç”±é…ç½®ä¿®æ”¹
```typescript
// web/src/app.tsx
import { history } from 'umi';

// æ£€æµ‹æ˜¯å¦åœ¨ qiankun ç¯å¢ƒä¸­è¿è¡Œ
const isQiankunEnv = window.__POWERED_BY_QIANKUN__;

// è·¯ç”±åŸºç¡€è·¯å¾„é…ç½®
const routerBase = isQiankunEnv ? '/ragflow' : '/';

// ä¿®æ”¹ history é…ç½®
if (isQiankunEnv) {
  // åœ¨ qiankun ç¯å¢ƒä¸­ï¼Œç›‘å¬è·¯ç”±å˜åŒ–
  history.listen((location) => {
    // ç¡®ä¿è·¯ç”±å˜åŒ–ä¸å½±å“ä¸»åº”ç”¨
    if (!location.pathname.startsWith('/ragflow')) {
      history.push('/ragflow' + location.pathname);
    }
  });
}
```

#### 3.2 è·¯ç”±å®ˆå«å®ç°
```typescript
// web/src/utils/routeGuard.ts
export class RouteGuard {
  private allowedPaths = ['/ragflow'];
  
  canActivate(path: string): boolean {
    return this.allowedPaths.some(allowedPath => 
      path.startsWith(allowedPath)
    );
  }
  
  redirect(path: string): string {
    if (!this.canActivate(path)) {
      return '/ragflow/chat'; // é»˜è®¤è·¯ç”±
    }
    return path;
  }
}
```

### 4. UMI å¾®å‰ç«¯æ”¹é€ 

#### 4.1 UMI é…ç½®ä¿®æ”¹
```typescript
// web/.umirc.ts
import { defineConfig } from 'umi';

export default defineConfig({
  // å¾®å‰ç«¯ç›¸å…³é…ç½®
  base: window.__POWERED_BY_QIANKUN__ ? '/ragflow/' : '/',
  publicPath: window.__POWERED_BY_QIANKUN__ ? '/ragflow/' : '/',
  
  // ç¦ç”¨ qiankun ä¸æ”¯æŒçš„åŠŸèƒ½
  history: {
    type: 'memory', // æ”¹ä¸º memory è·¯ç”±ï¼Œé¿å…ä¸ä¸»åº”ç”¨å†²çª
  },
  
  // webpack é…ç½®
  chainWebpack(config) {
    // ä¿®æ”¹è¾“å‡ºé…ç½®ï¼Œæ”¯æŒ UMD æ ¼å¼
    config.output
      .library('ragflow-react')
      .libraryTarget('umd')
      .globalObject('window');
    
    // å¤–éƒ¨åŒ–å¯èƒ½å†²çªçš„ä¾èµ–
    config.externals({
      'react': 'React',
      'react-dom': 'ReactDOM'
    });
    
    return config;
  },
  
  // æ ·å¼éš”ç¦»é…ç½®
  tailwindcss: {
    content: ['./src/**/*.{js,ts,jsx,tsx}'],
    prefix: 'tw-',
    important: '.ragflow-app',
  },
  
  // å¼€å‘æœåŠ¡å™¨é…ç½®
  devServer: {
    headers: {
      'Access-Control-Allow-Origin': '*',
    },
  },
});
```

#### 4.2 ç”Ÿå‘½å‘¨æœŸå‡½æ•°å®ç°
```typescript
// web/src/qiankun.tsx
import React from 'react';
import ReactDOM from 'react-dom';
import { globalManager } from './utils/sandbox';
import { eventManager } from './utils/eventManager';

let root: any;

// qiankun ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨åˆå§‹åŒ–
export async function bootstrap() {
  console.log('[RAGFlow] React app bootstraped');
  
  // ä¿å­˜å…¨å±€å˜é‡
  globalManager.saveGlobals();
}

// qiankun ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨æŒ‚è½½
export async function mount(props: any) {
  console.log('[RAGFlow] React app mount', props);
  
  const { container } = props;
  
  // åŠ¨æ€å¯¼å…¥ä¸»åº”ç”¨ç»„ä»¶
  const { default: App } = await import('./App');
  
  // åˆ›å»ºå®¹å™¨
  const mountNode = container ? container.querySelector('#ragflow-root') : document.getElementById('ragflow-root');
  
  if (!mountNode) {
    const newMountNode = document.createElement('div');
    newMountNode.id = 'ragflow-root';
    newMountNode.className = 'ragflow-app';
    (container || document.body).appendChild(newMountNode);
  }
  
  // ä½¿ç”¨ React 18 çš„ createRoot API
  const { createRoot } = await import('react-dom/client');
  root = createRoot(mountNode || document.getElementById('ragflow-root')!);
  
  root.render(
    <div className="ragflow-app">
      <App />
    </div>
  );
}

// qiankun ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨å¸è½½
export async function unmount(props: any) {
  console.log('[RAGFlow] React app unmount', props);
  
  // å¸è½½åº”ç”¨
  if (root) {
    root.unmount();
    root = null;
  }
  
  // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  eventManager.removeAllListeners();
  
  // æ¢å¤å…¨å±€å˜é‡
  globalManager.restoreGlobals();
}

// ç‹¬ç«‹è¿è¡Œæ—¶çš„æ¸²æŸ“å‡½æ•°
export function render(props: any = {}) {
  if (!window.__POWERED_BY_QIANKUN__) {
    mount(props);
  }
}

// å¦‚æœä¸æ˜¯åœ¨ qiankun ç¯å¢ƒä¸­ï¼Œç›´æ¥æ¸²æŸ“
if (!window.__POWERED_BY_QIANKUN__) {
  render();
}
```

#### 4.3 å…¥å£æ–‡ä»¶ä¿®æ”¹
```typescript
// web/src/app.tsx
import './qiankun'; // å¯¼å…¥ qiankun é…ç½®

export { bootstrap, mount, unmount } from './qiankun';

// åº”ç”¨è¿è¡Œæ—¶é…ç½®
export const qiankun = {
  // åº”ç”¨åŠ è½½ä¹‹å‰
  async bootstrap() {
    console.log('RAGFlow app bootstrap');
  },
  // åº”ç”¨ render ä¹‹å‰è§¦å‘
  async mount(props: any) {
    console.log('RAGFlow mount', props);
  },
  // åº”ç”¨å¸è½½ä¹‹åè§¦å‘
  async unmount(props: any) {
    console.log('RAGFlow unmount', props);
  },
};
```

### 5. Vue ä¸»åº”ç”¨é…ç½®

#### 5.1 å®‰è£…å’Œæ³¨å†Œå¾®åº”ç”¨
```typescript
// src/portal/main.js
import { registerMicroApps, start, addGlobalUncaughtErrorHandler } from 'qiankun';

// æ³¨å†Œ RAGFlow å¾®åº”ç”¨
registerMicroApps([
  {
    name: 'ragflow-react',
    entry: process.env.NODE_ENV === 'development' 
      ? '//localhost:8000' 
      : '/ragflow/',
    container: '#ragflow-container',
    activeRule: '/ragflow',
    props: {
      // ä¼ é€’ç»™å­åº”ç”¨çš„æ•°æ®
      routerBase: '/ragflow',
      userInfo: () => store.state.user,
      token: () => store.state.auth.token,
    }
  }
]);

// å…¨å±€é”™è¯¯å¤„ç†
addGlobalUncaughtErrorHandler((event) => {
  console.error('qiankun error:', event);
});

// å¯åŠ¨ qiankun
start({
  // æ ·å¼éš”ç¦»
  sandbox: {
    strictStyleIsolation: true, // ä¸¥æ ¼æ ·å¼éš”ç¦»
    experimentalStyleIsolation: true, // å®éªŒæ€§æ ·å¼éš”ç¦»
  },
  // é¢„åŠ è½½
  prefetch: 'all',
});
```

#### 5.2 å®¹å™¨ç»„ä»¶å®ç°
```vue
<!-- src/portal/views/ragflow/RagflowContainer.vue -->
<template>
  <div class="ragflow-container-wrapper">
    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading-wrapper">
      <div class="loading-spinner">æ­£åœ¨åŠ è½½ RAGFlow...</div>
    </div>
    
    <!-- å¾®åº”ç”¨å®¹å™¨ -->
    <div 
      id="ragflow-container" 
      class="ragflow-container"
      :class="{ 'loaded': !loading }"
    >
      <!-- qiankun ä¼šå°† RAGFlow åº”ç”¨æŒ‚è½½åˆ°è¿™é‡Œ -->
    </div>
  </div>
</template>

<script>
import { addGlobalUncaughtErrorHandler } from 'qiankun';

export default {
  name: 'RagflowContainer',
  data() {
    return {
      loading: true,
    };
  },
  mounted() {
    // ç›‘å¬å¾®åº”ç”¨åŠ è½½å®Œæˆ
    this.watchMicroAppMount();
    
    // é”™è¯¯å¤„ç†
    addGlobalUncaughtErrorHandler((event) => {
      this.handleMicroAppError(event);
    });
  },
  methods: {
    watchMicroAppMount() {
      // æ£€æŸ¥å¾®åº”ç”¨æ˜¯å¦å·²åŠ è½½
      const checkMount = () => {
        const container = document.getElementById('ragflow-container');
        if (container && container.children.length > 0) {
          this.loading = false;
        } else {
          setTimeout(checkMount, 100);
        }
      };
      
      setTimeout(checkMount, 100);
    },
    
    handleMicroAppError(event) {
      console.error('RAGFlow åº”ç”¨é”™è¯¯:', event);
      this.loading = false;
      this.$message.error('RAGFlow åº”ç”¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
    }
  }
};
</script>

<style scoped>
.ragflow-container-wrapper {
  width: 100%;
  height: 100vh;
  position: relative;
}

.ragflow-container {
  width: 100%;
  height: 100%;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.ragflow-container.loaded {
  opacity: 1;
}

.loading-wrapper {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f5;
  z-index: 1000;
}

.loading-spinner {
  font-size: 16px;
  color: #666;
}

/* éš”ç¦» RAGFlow æ ·å¼å½±å“ */
.ragflow-container :deep(.ragflow-app) {
  /* ç¡®ä¿ RAGFlow åº”ç”¨æ ·å¼ä¸å½±å“å¤–éƒ¨ */
  contain: layout style paint;
}
</style>
```

#### 5.3 è·¯ç”±é…ç½®
```javascript
// src/portal/core/router/map/ragflow.js
export default [
  {
    path: '/ragflow',
    name: 'ragflow',
    component: () => import('@/views/ragflow/RagflowContainer.vue'),
    meta: {
      title: 'RAGFlow AI åŠ©æ‰‹',
      keepAlive: false,
    },
    children: [
      {
        path: '*', // æ•è·æ‰€æœ‰ /ragflow/* è·¯ç”±
        component: () => import('@/views/ragflow/RagflowContainer.vue'),
      }
    ]
  }
];
```

### 6. é€šä¿¡æœºåˆ¶è®¾è®¡

#### 6.1 ä¸»åº”ç”¨å‘å­åº”ç”¨é€šä¿¡
```typescript
// ä¸»åº”ç”¨ä¸­
import { getGlobalState, setGlobalState } from 'qiankun';

// è®¾ç½®å…¨å±€çŠ¶æ€
setGlobalState({
  user: {
    id: '123',
    name: 'John Doe',
    token: 'xxx-token'
  },
  theme: 'dark'
});
```

```typescript
// RAGFlow å­åº”ç”¨ä¸­
export async function mount(props: any) {
  // æ¥æ”¶ä¸»åº”ç”¨ä¼ é€’çš„æ•°æ®
  const { user, theme } = props;
  
  // ç›‘å¬å…¨å±€çŠ¶æ€å˜åŒ–
  props.onGlobalStateChange?.((state: any, prev: any) => {
    console.log('å…¨å±€çŠ¶æ€å˜åŒ–:', state, prev);
    // æ›´æ–°å­åº”ç”¨çŠ¶æ€
    updateUserInfo(state.user);
    updateTheme(state.theme);
  });
  
  // è®¾ç½®å…¨å±€çŠ¶æ€
  props.setGlobalState?.({
    ragflowReady: true,
    currentChat: 'chat-123'
  });
}
```

#### 6.2 äº‹ä»¶é€šä¿¡æœºåˆ¶
```typescript
// web/src/utils/communication.ts
class MicroAppCommunication {
  private eventBus = new EventTarget();
  
  // å‘é€äº‹ä»¶åˆ°ä¸»åº”ç”¨
  emitToMain(eventName: string, data: any) {
    if (window.parent !== window) {
      window.parent.postMessage({
        type: 'RAGFLOW_EVENT',
        eventName,
        data
      }, '*');
    }
  }
  
  // ç›‘å¬æ¥è‡ªä¸»åº”ç”¨çš„äº‹ä»¶
  onMainEvent(callback: (event: any) => void) {
    window.addEventListener('message', (event) => {
      if (event.data.type === 'MAIN_TO_RAGFLOW') {
        callback(event.data);
      }
    });
  }
  
  // å†…éƒ¨äº‹ä»¶é€šä¿¡
  emit(eventName: string, data: any) {
    this.eventBus.dispatchEvent(new CustomEvent(eventName, { detail: data }));
  }
  
  on(eventName: string, callback: (event: any) => void) {
    this.eventBus.addEventListener(eventName, callback);
  }
}

export const communication = new MicroAppCommunication();
```

### 7. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 7.1 èµ„æºé¢„åŠ è½½
```typescript
// ä¸»åº”ç”¨ä¸­é¢„åŠ è½½ RAGFlow èµ„æº
import { prefetchApps } from 'qiankun';

// é¢„åŠ è½½å¾®åº”ç”¨
prefetchApps([
  {
    name: 'ragflow-react',
    entry: '//localhost:8000'
  }
]);
```

#### 7.2 æ‡’åŠ è½½ä¼˜åŒ–
```typescript
// web/src/utils/lazyLoad.ts
export function createLazyComponent(importFn: () => Promise<any>) {
  return React.lazy(() => {
    return new Promise((resolve) => {
      // å»¶è¿ŸåŠ è½½ï¼Œé¿å…é˜»å¡ä¸»åº”ç”¨
      setTimeout(() => {
        importFn().then(resolve);
      }, 0);
    });
  });
}
```

#### 7.3 å†…å­˜ç®¡ç†
```typescript
// web/src/utils/memoryManager.ts
class MemoryManager {
  private timers: number[] = [];
  private observers: IntersectionObserver[] = [];
  
  addTimer(timer: number) {
    this.timers.push(timer);
  }
  
  addObserver(observer: IntersectionObserver) {
    this.observers.push(observer);
  }
  
  cleanup() {
    // æ¸…ç†å®šæ—¶å™¨
    this.timers.forEach(timer => clearTimeout(timer));
    this.timers = [];
    
    // æ¸…ç†è§‚å¯Ÿå™¨
    this.observers.forEach(observer => observer.disconnect());
    this.observers = [];
  }
}

export const memoryManager = new MemoryManager();
```

### 8. å¼€å‘å’Œéƒ¨ç½²æµç¨‹

#### 8.1 å¼€å‘ç¯å¢ƒé…ç½®
```json
// web/package.json æ·»åŠ è„šæœ¬
{
  "scripts": {
    "dev:micro": "cross-env UMI_DEV_SERVER_COMPRESS=none umi dev --port 8000",
    "build:micro": "umi build",
    "serve:micro": "serve dist -l 8000 -s"
  }
}
```

#### 8.2 æ„å»ºè„šæœ¬
```bash
#!/bin/bash
# scripts/build-ragflow.sh

echo "Building RAGFlow for micro-frontend..."

cd web

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build:micro

# å¤åˆ¶æ„å»ºç»“æœåˆ°ä¸»åº”ç”¨
cp -r dist/* ../src/portal/static/ragflow/

echo "RAGFlow build completed!"
```

#### 8.3 éƒ¨ç½²é…ç½®
```nginx
# nginx é…ç½®
server {
    listen 80;
    server_name your-domain.com;
    
    # ä¸»åº”ç”¨
    location / {
        root /var/www/main-app;
        try_files $uri $uri/ /index.html;
    }
    
    # RAGFlow å­åº”ç”¨
    location /ragflow {
        alias /var/www/ragflow-app;
        try_files $uri $uri/ /ragflow/index.html;
        
        # è®¾ç½®æ­£ç¡®çš„ MIME ç±»å‹
        location ~* \.(js|css)$ {
            add_header Cache-Control "public, max-age=31536000";
        }
    }
    
    # API ä»£ç†
    location /api {
        proxy_pass http://127.0.0.1:9380;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 9. æµ‹è¯•ç­–ç•¥

#### 9.1 å•å…ƒæµ‹è¯•
```typescript
// web/src/__tests__/qiankun.test.ts
import { bootstrap, mount, unmount } from '../qiankun';

describe('RAGFlow qiankun lifecycle', () => {
  test('bootstrap should initialize correctly', async () => {
    await bootstrap();
    // æµ‹è¯•åˆå§‹åŒ–é€»è¾‘
  });
  
  test('mount should render app correctly', async () => {
    const container = document.createElement('div');
    await mount({ container });
    
    expect(container.querySelector('.ragflow-app')).toBeTruthy();
  });
  
  test('unmount should cleanup correctly', async () => {
    const container = document.createElement('div');
    await mount({ container });
    await unmount({ container });
    
    expect(container.innerHTML).toBe('');
  });
});
```

#### 9.2 é›†æˆæµ‹è¯•
```typescript
// tests/integration/ragflow-integration.test.ts
describe('RAGFlow Integration', () => {
  test('should load without style conflicts', async () => {
    // æµ‹è¯•æ ·å¼éš”ç¦»
    const mainAppStyles = getComputedStyle(document.body);
    // åŠ è½½ RAGFlow
    await loadRagflow();
    const newMainAppStyles = getComputedStyle(document.body);
    
    expect(mainAppStyles.fontSize).toBe(newMainAppStyles.fontSize);
  });
  
  test('should handle routing correctly', async () => {
    // æµ‹è¯•è·¯ç”±éš”ç¦»
    history.push('/ragflow/chat');
    expect(location.pathname).toBe('/ragflow/chat');
  });
});
```

### 10. ç›‘æ§å’Œè°ƒè¯•

#### 10.1 æ€§èƒ½ç›‘æ§
```typescript
// web/src/utils/monitor.ts
class PerformanceMonitor {
  trackLoadTime() {
    const start = performance.now();
    
    return () => {
      const end = performance.now();
      console.log(`RAGFlow load time: ${end - start}ms`);
      
      // ä¸ŠæŠ¥æ€§èƒ½æ•°æ®
      this.reportPerformance({
        type: 'load_time',
        duration: end - start,
        timestamp: Date.now()
      });
    };
  }
  
  trackMemoryUsage() {
    if ('memory' in performance) {
      const memory = (performance as any).memory;
      console.log('Memory usage:', {
        used: memory.usedJSHeapSize,
        total: memory.totalJSHeapSize,
        limit: memory.jsHeapSizeLimit
      });
    }
  }
  
  private reportPerformance(data: any) {
    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    fetch('/api/monitor/performance', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
  }
}

export const monitor = new PerformanceMonitor();
```

#### 10.2 é”™è¯¯è¾¹ç•Œ
```tsx
// web/src/components/ErrorBoundary.tsx
import React from 'react';

interface Props {
  children: React.ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class RagflowErrorBoundary extends React.Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }
  
  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }
  
  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('RAGFlow Error:', error, errorInfo);
    
    // ä¸ŠæŠ¥é”™è¯¯
    this.reportError(error, errorInfo);
  }
  
  reportError(error: Error, errorInfo: React.ErrorInfo) {
    fetch('/api/monitor/error', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: error.message,
        stack: error.stack,
        componentStack: errorInfo.componentStack,
        timestamp: Date.now()
      })
    });
  }
  
  render() {
    if (this.state.hasError) {
      return (
        <div className="ragflow-error-boundary">
          <h2>RAGFlow åº”ç”¨å‡ºç°é”™è¯¯</h2>
          <p>è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜</p>
          <button onClick={() => window.location.reload()}>
            åˆ·æ–°é¡µé¢
          </button>
        </div>
      );
    }
    
    return this.props.children;
  }
}
```

## ğŸ“ˆ å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ”¹é€ ï¼ˆ1-2å‘¨ï¼‰
1. ä¿®æ”¹ RAGFlow UMI é…ç½®æ”¯æŒå¾®å‰ç«¯
2. å®ç° qiankun ç”Ÿå‘½å‘¨æœŸå‡½æ•°
3. é…ç½®æ ·å¼éš”ç¦»æœºåˆ¶
4. ä¸»åº”ç”¨é›†æˆ qiankun

### é˜¶æ®µäºŒï¼šæ ·å¼å’ŒåŠŸèƒ½å®Œå–„ï¼ˆ1å‘¨ï¼‰
1. å®Œå–„æ ·å¼éš”ç¦»å’Œå‘½åç©ºé—´
2. å®ç°è·¯ç”±éš”ç¦»
3. æ·»åŠ é”™è¯¯å¤„ç†å’Œç›‘æ§
4. ä¼˜åŒ–åŠ è½½æ€§èƒ½

### é˜¶æ®µä¸‰ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
1. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
2. æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
3. å…¼å®¹æ€§æµ‹è¯•
4. æ–‡æ¡£ç¼–å†™

### é˜¶æ®µå››ï¼šéƒ¨ç½²å’Œç›‘æ§ï¼ˆ1å‘¨ï¼‰
1. é…ç½®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
2. å»ºç«‹ç›‘æ§ä½“ç³»
3. æ€§èƒ½è°ƒä¼˜
4. ç”¨æˆ·åé¦ˆæ”¶é›†

## ğŸ” é¢„æœŸæ•ˆæœ

- âœ… **å®Œå…¨æ ·å¼éš”ç¦»**ï¼šRAGFlow æ ·å¼ä¸å½±å“ä¸»åº”ç”¨
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‡’åŠ è½½å’Œé¢„åŠ è½½æœºåˆ¶
- âœ… **é”™è¯¯éš”ç¦»**ï¼šå­åº”ç”¨é”™è¯¯ä¸å½±å“ä¸»åº”ç”¨
- âœ… **å¼€å‘ä½“éªŒ**ï¼šæ”¯æŒç‹¬ç«‹å¼€å‘å’Œè°ƒè¯•
- âœ… **éƒ¨ç½²çµæ´»**ï¼šæ”¯æŒç‹¬ç«‹éƒ¨ç½²å’Œè”åˆéƒ¨ç½²

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç‰ˆæœ¬å…¼å®¹æ€§**ï¼šç¡®ä¿ Reactã€UMI ç‰ˆæœ¬ä¸ qiankun å…¼å®¹
2. **èµ„æºåŠ è½½**ï¼šæ³¨æ„é™æ€èµ„æºè·¯å¾„é…ç½®
3. **çŠ¶æ€ç®¡ç†**ï¼šé¿å…å…¨å±€çŠ¶æ€æ±¡æŸ“
4. **å†…å­˜æ³„æ¼**ï¼šåŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨å’Œå®šæ—¶å™¨
5. **SEO å½±å“**ï¼šå¾®å‰ç«¯å¯¹ SEO çš„å½±å“éœ€è¦è€ƒè™‘

é€šè¿‡è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆï¼Œå¯ä»¥ç¡®ä¿ RAGFlow React åº”ç”¨ä¸ Vue ä¸»åº”ç”¨å®Œç¾é›†æˆï¼Œé¿å…æ ·å¼å†²çªå’Œæ¸²æŸ“é—®é¢˜ï¼ŒåŒæ—¶ä¿æŒä¸¤ä¸ªåº”ç”¨çš„ç‹¬ç«‹æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 