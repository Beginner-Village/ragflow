<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾®åº”ç”¨ UMD æ ¼å¼æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
    }
    
    .test-section h3 {
      margin-top: 0;
      color: #333;
    }
    
    .button-group {
      margin: 10px 0;
    }
    
    .button {
      padding: 8px 16px;
      margin: 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .button-primary {
      background-color: #1890ff;
      color: white;
    }
    
    .button-danger {
      background-color: #ff4d4f;
      color: white;
    }
    
    .button-secondary {
      background-color: #f0f0f0;
      color: #333;
    }
    
    .log-container {
      background-color: #f8f8f8;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 15px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .status.success {
      background-color: #f6ffed;
      color: #52c41a;
      border: 1px solid #b7eb8f;
    }
    
    .status.error {
      background-color: #fff2f0;
      color: #ff4d4f;
      border: 1px solid #ffccc7;
    }
    
    .status.warning {
      background-color: #fffbe6;
      color: #faad14;
      border: 1px solid #ffe58f;
    }
    
    .micro-app-container {
      border: 2px solid #1890ff;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      min-height: 400px;
      background-color: #fafafa;
    }
    
    .info-card {
      background-color: #e6f7ff;
      border: 1px solid #91d5ff;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª RagFlow å¾®åº”ç”¨ UMD æ ¼å¼æµ‹è¯•</h1>
    
    <div class="info-card">
      <h4>æµ‹è¯•è¯´æ˜</h4>
      <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯• RagFlow å¾®åº”ç”¨çš„ UMD æ ¼å¼æ‰“åŒ…å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†åŠŸèƒ½ã€‚</p>
      <p>è¯·ç¡®ä¿å·²ä½¿ç”¨ <code>MICRO_APP=true npm run build</code> æ„å»ºå¾®åº”ç”¨ã€‚</p>
    </div>
    
    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div class="test-section">
      <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
      <div id="status-container">
        <div class="status warning">æœªå¼€å§‹æµ‹è¯•</div>
      </div>
    </div>
    
    <!-- ç”Ÿå‘½å‘¨æœŸæµ‹è¯• -->
    <div class="test-section">
      <h3>ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†æµ‹è¯•</h3>
      <div class="button-group">
        <button class="button button-primary" onclick="testBootstrap()">Bootstrap</button>
        <button class="button button-primary" onclick="testMount()">Mount</button>
        <button class="button button-danger" onclick="testUnmount()">Unmount</button>
        <button class="button button-secondary" onclick="testUpdate()">Update</button>
      </div>
      <div>
        <strong>æ´»è·ƒè¯·æ±‚æ•°é‡:</strong> <span id="active-requests">0</span>
        <button class="button button-secondary" onclick="updateRequestCount()">åˆ·æ–°</button>
      </div>
    </div>
    
    <!-- UMD æ ¼å¼æµ‹è¯• -->
    <div class="test-section">
      <h3>ğŸ“¦ UMD æ ¼å¼æµ‹è¯•</h3>
      <div class="button-group">
        <button class="button button-primary" onclick="loadUMDScript()">åŠ è½½ UMD è„šæœ¬</button>
        <button class="button button-secondary" onclick="checkGlobalExports()">æ£€æŸ¥å…¨å±€å¯¼å‡º</button>
        <button class="button button-secondary" onclick="testRouteChange()">æ¨¡æ‹Ÿè·¯ç”±åˆ‡æ¢</button>
      </div>
    </div>
    
    <!-- æ—¥å¿—æ˜¾ç¤º -->
    <div class="test-section">
      <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
      <div class="button-group">
        <button class="button button-secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
      </div>
      <div id="log-container" class="log-container"></div>
    </div>
    
    <!-- å¾®åº”ç”¨å®¹å™¨ -->
    <div class="test-section">
      <h3>ğŸ  å¾®åº”ç”¨å®¹å™¨</h3>
      <div id="micro-app-container" class="micro-app-container">
        <p>å¾®åº”ç”¨å°†åœ¨è¿™é‡ŒåŠ è½½...</p>
      </div>
    </div>
  </div>

  <script>
    // æ—¥å¿—ç®¡ç†
    const logContainer = document.getElementById('log-container');
    const statusContainer = document.getElementById('status-container');
    const activeRequestsSpan = document.getElementById('active-requests');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `[${timestamp}] ${message}`;
      logEntry.style.color = type === 'error' ? '#ff4d4f' : 
                           type === 'success' ? '#52c41a' : 
                           type === 'warning' ? '#faad14' : '#333';
      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    function updateStatus(message, type = 'info') {
      statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
    }
    
    function clearLogs() {
      logContainer.innerHTML = '';
    }
    
    // å¾®åº”ç”¨ç®¡ç†
    let ragflowApp = null;
    let isAppMounted = false;
    
    // æ¨¡æ‹Ÿä¸»åº”ç”¨ä¼ é€’çš„ props
    const mockProps = {
      routerBase: '/ragflow/',
      authInfo: {
        token: 'test-token-123',
        userId: 'test-user'
      }
    };
    
    // ç”Ÿå‘½å‘¨æœŸæµ‹è¯•å‡½æ•°
    async function testBootstrap() {
      try {
        log('ğŸš€ å¼€å§‹ Bootstrap æµ‹è¯•...', 'info');
        
        if (!ragflowApp) {
          log('âŒ å¾®åº”ç”¨æœªåŠ è½½', 'error');
          updateStatus('å¾®åº”ç”¨æœªåŠ è½½', 'error');
          return;
        }
        
        if (ragflowApp.bootstrap) {
          await ragflowApp.bootstrap(mockProps);
          log('âœ… Bootstrap æˆåŠŸ', 'success');
          updateStatus('Bootstrap å®Œæˆ', 'success');
        } else {
          log('âŒ Bootstrap æ–¹æ³•ä¸å­˜åœ¨', 'error');
        }
      } catch (error) {
        log(`âŒ Bootstrap å¤±è´¥: ${error.message}`, 'error');
        updateStatus('Bootstrap å¤±è´¥', 'error');
      }
    }
    
    async function testMount() {
      try {
        log('ğŸ“¦ å¼€å§‹ Mount æµ‹è¯•...', 'info');
        
        if (!ragflowApp) {
          log('âŒ å¾®åº”ç”¨æœªåŠ è½½', 'error');
          updateStatus('å¾®åº”ç”¨æœªåŠ è½½', 'error');
          return;
        }
        
        if (isAppMounted) {
          log('âš ï¸ åº”ç”¨å·²æŒ‚è½½ï¼Œå…ˆå¸è½½', 'warning');
          await testUnmount();
        }
        
        if (ragflowApp.mount) {
          await ragflowApp.mount(mockProps);
          isAppMounted = true;
          log('âœ… Mount æˆåŠŸ', 'success');
          updateStatus('åº”ç”¨å·²æŒ‚è½½', 'success');
          updateRequestCount();
        } else {
          log('âŒ Mount æ–¹æ³•ä¸å­˜åœ¨', 'error');
        }
      } catch (error) {
        log(`âŒ Mount å¤±è´¥: ${error.message}`, 'error');
        updateStatus('Mount å¤±è´¥', 'error');
      }
    }
    
    async function testUnmount() {
      try {
        log('ğŸ“¤ å¼€å§‹ Unmount æµ‹è¯•...', 'info');
        
        if (!ragflowApp) {
          log('âŒ å¾®åº”ç”¨æœªåŠ è½½', 'error');
          return;
        }
        
        if (ragflowApp.unmount) {
          await ragflowApp.unmount(mockProps);
          isAppMounted = false;
          log('âœ… Unmount æˆåŠŸ', 'success');
          updateStatus('åº”ç”¨å·²å¸è½½', 'warning');
          updateRequestCount();
        } else {
          log('âŒ Unmount æ–¹æ³•ä¸å­˜åœ¨', 'error');
        }
      } catch (error) {
        log(`âŒ Unmount å¤±è´¥: ${error.message}`, 'error');
        updateStatus('Unmount å¤±è´¥', 'error');
      }
    }
    
    async function testUpdate() {
      try {
        log('ğŸ”„ å¼€å§‹ Update æµ‹è¯•...', 'info');
        
        if (!ragflowApp) {
          log('âŒ å¾®åº”ç”¨æœªåŠ è½½', 'error');
          return;
        }
        
        const updateProps = {
          ...mockProps,
          authInfo: {
            ...mockProps.authInfo,
            token: 'updated-token-456'
          }
        };
        
        if (ragflowApp.update) {
          await ragflowApp.update(updateProps);
          log('âœ… Update æˆåŠŸ', 'success');
          updateStatus('åº”ç”¨å·²æ›´æ–°', 'success');
        } else {
          log('âŒ Update æ–¹æ³•ä¸å­˜åœ¨', 'error');
        }
      } catch (error) {
        log(`âŒ Update å¤±è´¥: ${error.message}`, 'error');
        updateStatus('Update å¤±è´¥', 'error');
      }
    }
    
    // UMD æ ¼å¼æµ‹è¯•
    function loadUMDScript() {
      log('ğŸ“¦ å¼€å§‹åŠ è½½ UMD è„šæœ¬...', 'info');
      
      // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
      if (window.ragflow || window.ragflowLifecycles) {
        log('âš ï¸ UMD è„šæœ¬å·²åŠ è½½', 'warning');
        ragflowApp = window.ragflow || window.ragflowLifecycles;
        updateStatus('UMD è„šæœ¬å·²åŠ è½½', 'success');
        return;
      }
      
      // åŠ¨æ€åŠ è½½ UMD è„šæœ¬
      const script = document.createElement('script');
      script.src = '/dist/umi.js'; // å‡è®¾è¿™æ˜¯ UMD æ ¼å¼çš„æ–‡ä»¶
      script.onload = () => {
        log('âœ… UMD è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
        ragflowApp = window.ragflow || window.ragflowLifecycles;
        updateStatus('UMD è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
        checkGlobalExports();
      };
      script.onerror = () => {
        log('âŒ UMD è„šæœ¬åŠ è½½å¤±è´¥', 'error');
        updateStatus('UMD è„šæœ¬åŠ è½½å¤±è´¥', 'error');
      };
      
      document.head.appendChild(script);
    }
    
    function checkGlobalExports() {
      log('ğŸ” æ£€æŸ¥å…¨å±€å¯¼å‡º...', 'info');
      
      const exports = [];
      
      if (window.ragflow) {
        exports.push('window.ragflow');
      }
      
      if (window.ragflowLifecycles) {
        exports.push('window.ragflowLifecycles');
      }
      
      if (window.ragflowMicroApp) {
        exports.push('window.ragflowMicroApp');
      }
      
      if (exports.length > 0) {
        log(`âœ… æ‰¾åˆ°å…¨å±€å¯¼å‡º: ${exports.join(', ')}`, 'success');
        
        // æ£€æŸ¥ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
        const app = window.ragflow || window.ragflowLifecycles || window.ragflowMicroApp;
        if (app) {
          const methods = ['bootstrap', 'mount', 'unmount', 'update'];
          const availableMethods = methods.filter(method => typeof app[method] === 'function');
          log(`ğŸ“‹ å¯ç”¨æ–¹æ³•: ${availableMethods.join(', ')}`, 'info');
        }
      } else {
        log('âŒ æœªæ‰¾åˆ°å…¨å±€å¯¼å‡º', 'error');
      }
    }
    
    function testRouteChange() {
      log('ğŸ”„ æ¨¡æ‹Ÿè·¯ç”±åˆ‡æ¢...', 'info');
      
      // æ¨¡æ‹Ÿè·¯ç”±å˜åŒ–
      const routes = ['/ragflow/', '/ragflow/chat', '/ragflow/knowledge', '/ragflow/'];
      let currentIndex = 0;
      
      const interval = setInterval(() => {
        const route = routes[currentIndex];
        window.history.pushState({}, '', route);
        log(`ğŸ§­ è·¯ç”±åˆ‡æ¢åˆ°: ${route}`, 'info');
        
        // æ›´æ–°è¯·æ±‚è®¡æ•°
        updateRequestCount();
        
        currentIndex++;
        if (currentIndex >= routes.length) {
          clearInterval(interval);
          log('âœ… è·¯ç”±åˆ‡æ¢æµ‹è¯•å®Œæˆ', 'success');
        }
      }, 1000);
    }
    
    function updateRequestCount() {
      let count = 0;
      
      if (window.ragflowActiveRequests) {
        count = window.ragflowActiveRequests.length;
      }
      
      activeRequestsSpan.textContent = count;
      log(`ğŸ“Š æ´»è·ƒè¯·æ±‚æ•°é‡: ${count}`, 'info');
    }
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      log('ğŸ‰ æµ‹è¯•é¡µé¢å·²åŠ è½½', 'success');
      updateStatus('æµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª', 'success');
      
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰å…¨å±€å¯¼å‡º
      checkGlobalExports();
      
      // å®šæœŸæ›´æ–°è¯·æ±‚è®¡æ•°
      setInterval(updateRequestCount, 5000);
    });
    
    // ç›‘å¬æ§åˆ¶å°è¾“å‡º
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      if (args[0] && typeof args[0] === 'string' && args[0].includes('ragflow')) {
        log(`ğŸ–¥ï¸ Console: ${args.join(' ')}`, 'info');
      }
    };
  </script>
</body>
</html> 